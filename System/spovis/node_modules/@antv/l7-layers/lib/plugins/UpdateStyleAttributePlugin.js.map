{"version":3,"sources":["../../src/plugins/UpdateStyleAttributePlugin.ts"],"names":["UpdateStyleAttributePlugin","TYPES","ILogService","layer","styleAttributeService","hooks","init","tap","updateStyleAtrribute","beforeRenderData","flag","layerModelNeedUpdate","beforeRender","attributes","getLayerStyleAttributes","filter","getLayerStyleAttribute","needRegenerateVertices","forEach","attr","attribute","updateAttributeByFeatureRange","name","getEncodedData","featureRange","startIndex","endIndex","logger","debug"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;;AAOA;;;;IAMqBA,0B,WADpB,4B,UAEE,uBAAOC,cAAMC,WAAb,C;;;;;;;;0BAICC,K,QAIA;AAAA;;AAAA,UAFEC,qBAEF,QAFEA,qBAEF;AACAD,MAAAA,KAAK,CAACE,KAAN,CAAYC,IAAZ,CAAiBC,GAAjB,CAAqB,4BAArB,EAAmD,YAAM;AACvD,QAAA,KAAI,CAACC,oBAAL,CAA0BL,KAA1B,EAAiC;AAAEC,UAAAA,qBAAqB,EAArBA;AAAF,SAAjC;AACD,OAFD;AAIAD,MAAAA,KAAK,CAACE,KAAN,CAAYI,gBAAZ,CAA6BF,GAA7B,CAAiC,uBAAjC,EAA0D,UAACG,IAAD,EAAU;AAClE,YAAIA,IAAJ,EAAU;AAIRP,UAAAA,KAAK,CAACQ,oBAAN,GAA6B,IAA7B;AACA,iBAAO,IAAP;AACD;;AACD,eAAO,KAAP;AACD,OATD;AAWAR,MAAAA,KAAK,CAACE,KAAN,CAAYO,YAAZ,CAAyBL,GAAzB,CAA6B,4BAA7B,EAA2D,YAAM;AAC/D,YAAIJ,KAAK,CAACQ,oBAAV,EAAgC;AAC9B;AACD;;AACD,QAAA,KAAI,CAACH,oBAAL,CAA0BL,KAA1B,EAAiC;AAAEC,UAAAA,qBAAqB,EAArBA;AAAF,SAAjC;AACD,OALD;AAMD;;;yCAECD,K,SAIA;AAAA;;AAAA,UAFEC,qBAEF,SAFEA,qBAEF;AACA,UAAMS,UAAU,GAAGT,qBAAqB,CAACU,uBAAtB,MAAmD,EAAtE;AACA,UAAMC,MAAM,GAAGX,qBAAqB,CAACY,sBAAtB,CAA6C,QAA7C,CAAf;;AACA,UAAID,MAAM,IAAIA,MAAM,CAACE,sBAArB,EAA6C;AAC3Cd,QAAAA,KAAK,CAACQ,oBAAN,GAA6B,IAA7B;AACAE,QAAAA,UAAU,CAACK,OAAX,CAAmB,UAACC,IAAD;AAAA,iBAAWA,IAAI,CAACF,sBAAL,GAA8B,KAAzC;AAAA,SAAnB;AACA;AACD;;AACDJ,MAAAA,UAAU,CACPE,MADH,CACU,UAACK,SAAD;AAAA,eAAeA,SAAS,CAACH,sBAAzB;AAAA,OADV,EAEGC,OAFH,CAEW,UAACE,SAAD,EAAe;AAEtBhB,QAAAA,qBAAqB,CAACiB,6BAAtB,CACED,SAAS,CAACE,IADZ,EAEEnB,KAAK,CAACoB,cAAN,EAFF,EAGEH,SAAS,CAACI,YAAV,CAAuBC,UAHzB,EAIEL,SAAS,CAACI,YAAV,CAAuBE,QAJzB;AAMAN,QAAAA,SAAS,CAACH,sBAAV,GAAmC,KAAnC;;AACA,QAAA,MAAI,CAACU,MAAL,CAAYC,KAAZ,yCACmCR,SAAS,CAACE,IAD7C;AAGD,OAdH;AAeD","sourcesContent":["import {\n  ILayer,\n  ILayerPlugin,\n  ILogService,\n  IStyleAttributeService,\n  TYPES,\n} from '@antv/l7-core';\nimport { inject, injectable } from 'inversify';\n\n/**\n * 在初始化阶段完成属性的注册，以及首次根据 Layer 指定的三角化方法完成 indices 和 attribute 的创建\n */\n@injectable()\nexport default class UpdateStyleAttributePlugin implements ILayerPlugin {\n  @inject(TYPES.ILogService)\n  private readonly logger: ILogService;\n\n  public apply(\n    layer: ILayer,\n    {\n      styleAttributeService,\n    }: { styleAttributeService: IStyleAttributeService },\n  ) {\n    layer.hooks.init.tap('UpdateStyleAttributePlugin', () => {\n      this.updateStyleAtrribute(layer, { styleAttributeService });\n    });\n\n    layer.hooks.beforeRenderData.tap('styleAttributeService', (flag) => {\n      if (flag) {\n        // styleAttributeService.createAttributesAndIndices(\n        //   layer.getEncodedData(),\n        // );\n        layer.layerModelNeedUpdate = true;\n        return true;\n      }\n      return false;\n    });\n\n    layer.hooks.beforeRender.tap('UpdateStyleAttributePlugin', () => {\n      if (layer.layerModelNeedUpdate) {\n        return;\n      }\n      this.updateStyleAtrribute(layer, { styleAttributeService });\n    });\n  }\n  private updateStyleAtrribute(\n    layer: ILayer,\n    {\n      styleAttributeService,\n    }: { styleAttributeService: IStyleAttributeService },\n  ) {\n    const attributes = styleAttributeService.getLayerStyleAttributes() || [];\n    const filter = styleAttributeService.getLayerStyleAttribute('filter');\n    if (filter && filter.needRegenerateVertices) {\n      layer.layerModelNeedUpdate = true;\n      attributes.forEach((attr) => (attr.needRegenerateVertices = false));\n      return;\n    }\n    attributes\n      .filter((attribute) => attribute.needRegenerateVertices)\n      .forEach((attribute) => {\n        // 精确更新某个/某些 feature(s)，需要传入 featureIdx d\n        styleAttributeService.updateAttributeByFeatureRange(\n          attribute.name,\n          layer.getEncodedData(), // 获取经过 mapping 最新的数据\n          attribute.featureRange.startIndex,\n          attribute.featureRange.endIndex,\n        );\n        attribute.needRegenerateVertices = false;\n        this.logger.debug(\n          `regenerate vertex attributes: ${attribute.name} finished`,\n        );\n      });\n  }\n}\n"],"file":"UpdateStyleAttributePlugin.js"}